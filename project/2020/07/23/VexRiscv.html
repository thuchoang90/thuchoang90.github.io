<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>VexRiscv: A 32-bit RISC-V Microcontroller | Thuctorial</title>
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="VexRiscv: A 32-bit RISC-V Microcontroller">
<meta name="author" content="thuchoang90">
<meta property="og:locale" content="en_US">
<meta name="description" content="I. VexRiscv CPU">
<meta property="og:description" content="I. VexRiscv CPU">
<link rel="canonical" href="/jekyll-theme-yat/project/2020/07/23/VexRiscv.html">
<meta property="og:url" content="/jekyll-theme-yat/project/2020/07/23/VexRiscv.html">
<meta property="og:site_name" content="Thuctorial">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-07-23T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="VexRiscv: A 32-bit RISC-V Microcontroller">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"thuchoang90"},"dateModified":"2020-07-23T00:00:00+00:00","datePublished":"2020-07-23T00:00:00+00:00","description":"I. VexRiscv CPU","headline":"VexRiscv: A 32-bit RISC-V Microcontroller","mainEntityOfPage":{"@type":"WebPage","@id":"/jekyll-theme-yat/project/2020/07/23/VexRiscv.html"},"url":"/jekyll-theme-yat/project/2020/07/23/VexRiscv.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/jekyll-theme-yat/assets/css/main.css">
  <script src="/jekyll-theme-yat/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="/jekyll-theme-yat/feed.xml" title="Thuctorial">
<script>
  function initGoogleAnalytics() {
    var doNotTrack = (window.doNotTrack === "1" || navigator.doNotTrack === "1" ||
      navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1");
    var enableDNT = "true" == "true";

    if (!enableDNT || !doNotTrack) {
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'Tracking ID', 'auto');
      ga('send', 'pageview');
    }
  }
  window.addEventListener("load", initGoogleAnalytics);
</script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/jekyll-theme-yat/">
  <img class="site-favicon" title="Thuctorial" src="" onerror="this.style.display='none'">
  Thuctorial
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/jekyll-theme-yat/">HOME</a><a class="page-link" href="/jekyll-theme-yat/teaching.html">TEACHING</a><a class="page-link" href="/jekyll-theme-yat/tutorial.html">TUTORIAL</a><a class="page-link" href="/jekyll-theme-yat/project.html">PROJECT</a><a class="page-link" href="/jekyll-theme-yat/tags.html">TAGS</a><a class="page-link" href="/jekyll-theme-yat/about.html">ABOUT</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ja">
          
          <img src="https://cdn.countryflags.com/thumbs/japan/flag-400.png" title="Japanese">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="vi">
          
          <img src="https://cdn.countryflags.com/thumbs/vietnam/flag-400.png" title="Vietnamese">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</span>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">VexRiscv: A 32-bit RISC-V Microcontroller</h1>
  <h2 class="post-subtitle"></h2>

  <p class="post-meta">
    <time class="dt-published" datetime="2020-07-23T00:00:00+00:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jul 23, 2020
    </time>

    
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 11 mins</span>
  </p>
<div class="post-tags">
<a class="post-tag" href="/jekyll-theme-yat/tags.html#RISC-V">#RISC-V</a><a class="post-tag" href="/jekyll-theme-yat/tags.html#FPGA">#FPGA</a>
</div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <h2 id="i-vexriscv-cpu">I. VexRiscv CPU</h2>

<p>VexRiscv CPU is a 5-stage 32-bit RISC-V CPU.
The ISA that VexRiscv is using is <strong>rv32i</strong> for the <code class="language-plaintext highlighter-rouge">SmallestGen</code>, <strong>rv32im</strong> for <code class="language-plaintext highlighter-rouge">GenFull</code>, and <strong>rv32ima</strong> for <code class="language-plaintext highlighter-rouge">LinuxGen</code>.</p>

<p>Original <a href="https://github.com/SpinalHDL/VexRiscv">repository</a>. Modified <a href="https://github.com/thuchoang90/VexRiscv">repository</a>.</p>

<h3 id="i-a-make--self-test">I. a) Make &amp; self-test</h3>

<p>First, git clone the folder:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/thuchoang90/VexRiscv.git
<span class="nv">$ </span><span class="nb">cd </span>VexRiscv/
<span class="nv">$ </span>git submodule update <span class="nt">--init</span> <span class="nt">--recursive</span>
</code></pre></div></div>
<p>VexRiscv CPU has many build options:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>VexRiscv/    <span class="c">#go to your VexRiscv folder</span>

<span class="k">for </span>smallest CPU:
<span class="nv">$ </span>sbt <span class="s2">"runMain vexriscv.demo.GenSmallest"</span>

<span class="k">for </span>GenFull CPU:
<span class="nv">$ </span>sbt <span class="s2">"runMain vexriscv.demo.GenFull"</span>

<span class="k">for </span>Linux CPU:
<span class="nv">$ </span>sbt <span class="s2">"runMain vexriscv.demo.LinuxGen"</span>
</code></pre></div></div>

<p>Self-test using Verilator:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>VexRiscv/    <span class="c">#go to your VexRiscv folder</span>
<span class="nv">$ </span><span class="nb">cd </span>src/test/cpp/regression/

<span class="k">for </span>GenSmallest:
<span class="nv">$ </span>make clean run <span class="nv">IBUS</span><span class="o">=</span>SIMPLE <span class="nv">DBUS</span><span class="o">=</span>SIMPLE <span class="nv">CSR</span><span class="o">=</span>no <span class="nv">MMU</span><span class="o">=</span>no <span class="nv">DEBUG_PLUGIN</span><span class="o">=</span>no <span class="nv">MUL</span><span class="o">=</span>no <span class="nv">DIV</span><span class="o">=</span>no

<span class="k">for </span>GenFull:
<span class="nv">$ </span>make clean run

<span class="k">for </span>LinuxGen:
<span class="nv">$ </span>make clean run <span class="nv">IBUS</span><span class="o">=</span>CACHED <span class="nv">DBUS</span><span class="o">=</span>CACHED <span class="nv">DEBUG_PLUGIN</span><span class="o">=</span>STD <span class="nv">DHRYSTONE</span><span class="o">=</span><span class="nb">yes </span><span class="nv">SUPERVISOR</span><span class="o">=</span><span class="nb">yes </span><span class="nv">MMU</span><span class="o">=</span><span class="nb">yes </span><span class="nv">CSR</span><span class="o">=</span><span class="nb">yes </span><span class="nv">DEBUG_PLUGIN</span><span class="o">=</span>no <span class="nv">COMPRESSED</span><span class="o">=</span>no <span class="nv">MUL</span><span class="o">=</span><span class="nb">yes </span><span class="nv">DIV</span><span class="o">=</span><span class="nb">yes </span><span class="nv">LRSC</span><span class="o">=</span><span class="nb">yes </span><span class="nv">AMO</span><span class="o">=</span><span class="nb">yes </span><span class="nv">REDO</span><span class="o">=</span>10 <span class="nv">TRACE</span><span class="o">=</span>no <span class="nv">COREMARK</span><span class="o">=</span><span class="nb">yes </span><span class="nv">LINUX_REGRESSION</span><span class="o">=</span><span class="nb">yes</span>
</code></pre></div></div>

<h3 id="i-b-spinalhdl-source-code-library">I. b) SpinalHDL source-code library</h3>

<p>VexRiscv CPUs are constructed based on the SpinalHDL library. Reference <a href="https://github.com/SpinalHDL/SpinalHDL">link</a>.</p>

<p>Actually, this library is downloaded and embedded into the system automatically while we are generating CPUs at those steps above.
However, because it is hard to navigate the sources in an embedded library, it is recommended to git clone the library again in a separated folder for more accessible to search for the library source codes.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/SpinalHDL/SpinalHDL.git    <span class="c">#branch master commit 647e8974 on 27-Mar-2020</span>
<span class="nv">$ </span><span class="nb">cd </span>SpinalHDL/
<span class="nv">$ </span>git submodule update <span class="nt">--init</span> <span class="nt">--recursive</span>
  <span class="c">#the library source-code are under the folder: lib/src/main/scala/spinal/lib/</span>
</code></pre></div></div>

<h3 id="i-c-vexriscvs-openocd">I. c) VexRiscv’s OpenOCD</h3>

<p>OpenOCD tool that custom-made by the SpinalHDL group for this VexRiscv CPU.
<em>(the generic OpenOCD tool in the <a href="/tutorial/2022/09/30/Fresh-Ubuntu-setup#h-ii-g-openocd">Fresh-Ubuntu-setup</a> won’t work)</em></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/SpinalHDL/openocd_riscv.git vexriscv-openocd
  <span class="c">#branch riscv_spinal commit 92c05420 on 13-Mar-2020</span>
<span class="nv">$ </span><span class="nb">cd </span>vexriscv-openocd/
<span class="nv">$ </span>git submodule update <span class="nt">--init</span> <span class="nt">--recursive</span>
<span class="nv">$ </span>./bootstrap
<span class="nv">$ </span>./configure <span class="nt">--enable-ftdi</span> <span class="nt">--enable-dummy</span>
<span class="nv">$ </span>make
</code></pre></div></div>

<h3 id="i-d-debug-genfull-cpu-with-verilator--openocd--gdb">I. d) Debug GenFull CPU with Verilator + OpenOCD + GDB</h3>

<p>Open three terminals separately: one for Verilator, one for OpenOCD, and one for GDB.
On the first terminal, run Verilator:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>VexRiscv/                          <span class="c">#go to your VexRiscv folder</span>
<span class="nv">$ </span>sbt <span class="s2">"runMain vexriscv.demo.GenFull"</span>   <span class="c">#make sure that GenFull is generated</span>
<span class="nv">$ </span><span class="nb">cd </span>src/test/cpp/regression/
<span class="nv">$ </span>make clean run <span class="nv">DEBUG_PLUGIN_EXTERNAL</span><span class="o">=</span><span class="nb">yes</span>
</code></pre></div></div>

<p>On the second terminal, run OpenOCD:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>vexriscv_openocd/    <span class="c">#go to your vexriscv_openocd folder</span>
<span class="nv">$ </span>src/openocd <span class="nt">-c</span> <span class="s2">"set VEXRISCV_YAML &lt;cpu0.yaml PATH&gt;"</span> <span class="nt">-f</span> tcl/target/vexriscv_sim.cfg
  where &lt;cpu0.yaml PATH&gt; point to the file cpu0.yaml <span class="k">in </span>the VexRiscv folder
  For example:
  <span class="nv">$ </span>src/openocd <span class="nt">-c</span> <span class="s2">"set VEXRISCV_YAML /home/ubuntu/Projects/VexRiscv/cpu0.yaml"</span> <span class="nt">-f</span> tcl/target/vexriscv_sim.cfg
</code></pre></div></div>

<p>Finally, on the third terminal, run GDB:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>                              <span class="c">#check that if the riscv toolchain is on the PATH or not</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/opt/riscv/bin/:<span class="nv">$PATH</span>       <span class="c">#if not, then export the riscv toolchain to the PATH</span>

<span class="nv">$ </span><span class="nb">cd </span>VexRiscv/                            <span class="c">#go to your VexRiscv folder</span>
<span class="nv">$ </span>riscv64-unknown-elf-gdb src/test/resources/elf/uart.elf   <span class="c">#run the software with gdb tool</span>
<span class="nv">$ </span>target extended-remote localhost:3333   <span class="c">#connect to the hardware (right now is emulated by verilator)</span>
<span class="nv">$ </span>monitor reset halt
<span class="nv">$ </span>load
<span class="nv">$ </span><span class="k">continue</span>                                <span class="c">#after this, it should prints messages to the Verilator terminal</span>
</code></pre></div></div>

<hr>

<h2 id="ii-briey-soc">II. Briey SoC</h2>

<p>Briey SoC is a system consists of GenFull CPU + AXI bus + device modules (RAM, UART, GPIO, etc).</p>

<h3 id="ii-a-briey-soc-software-demo">II. a) Briey SoC software demo</h3>

<p>Sample sofwares for Briey SoC can be found at: <a href="https://github.com/thuchoang90/briey_software">github.com/thuchoang90/briey_software</a></p>

<p>First, clone the Briey SoC software demo to your local machine.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/thuchoang90/briey_software.git
</code></pre></div></div>

<p>This contains the first test demo under the <code class="language-plaintext highlighter-rouge">test/</code> folder, and some other example demos, including chip demos.</p>

<h3 id="ii-b-debug-briey-soc-with-verilator--openocd--gdb">II. b) Debug Briey SoC with Verilator + OpenOCD + GDB</h3>

<p>The Verilator emulates the Briey SoC.
If you are using FPGA (or chip), then the real hardware will replace the Verilator. But the running scheme stays the same.</p>

<p>The OpenOCD makes the bridge between hardware and software: the <code class="language-plaintext highlighter-rouge">vexriscv_openocd/</code> prepared in <a href="#i-c-vexriscvs-openocd">I.c) VexRiscv’s OpenOCD</a>).</p>

<p>The GDB is a native tool of the toolchain for debugging the hardware. The GDB can be replaced by other debugging tools such as Eclipse.</p>

<p>To debug the Briey SoC with Verilator + OpenOCD + GDB:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>First, run the Verilator:
<span class="nv">$ </span><span class="nb">cd </span>VexRiscv/                            <span class="c">#cd to your VexRiscv folder</span>
<span class="nv">$ </span>sbt <span class="s2">"runMain vexriscv.demo.Briey"</span>       <span class="c">#make sure that Briey SoC is generated</span>
<span class="nv">$ </span><span class="nb">cd </span>src/test/cpp/briey/
<span class="nv">$ </span>make clean run
	
Keep the Verilator terminal running, open a second terminal to run OpenOCD:
<span class="nv">$ </span><span class="nb">cd </span>vexriscv_openocd/                    <span class="c">#cd to your vexriscv_openocd folder</span>
<span class="nv">$ </span>src/openocd <span class="nt">-f</span> tcl/interface/jtag_tcp.cfg <span class="nt">-c</span> <span class="s2">"set BRIEY_CPU0_YAML &lt;cpu0.yaml PATH&gt;"</span> <span class="nt">-f</span> tcl/target/briey.cfg
  where &lt;cpu0.yaml PATH&gt; point to the file cpu0.yaml <span class="k">in </span>the VexRiscv folder
  For example:
  <span class="nv">$ </span>src/openocd <span class="nt">-f</span> tcl/interface/jtag_tcp.cfg <span class="nt">-c</span> <span class="s2">"set BRIEY_CPU0_YAML /home/ubuntu/Projects/VexRiscv/cpu0.yaml"</span> <span class="nt">-f</span> tcl/target/briey.cfg

Keep both Verilator and OpenOCD terminals running, open a third terminal to run GDB:
<span class="nv">$ </span><span class="nb">cd </span>briey_software/                      <span class="c">#cd to your briey_software/ folder</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>                            <span class="c">#check that if the riscv toolchain is on the PATH or not</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/opt/riscv/bin:<span class="nv">$PATH</span>        <span class="c">#if not, then export the riscv toolchain to the PATH</span>
<span class="nv">$ </span>riscv64-unknown-elf-gdb <span class="nb">test</span>/build/briey.elf
<span class="nv">$ </span>target extended-remote localhost:3333
<span class="nv">$ </span>monitor reset halt
<span class="nv">$ </span>load
<span class="nv">$ </span><span class="k">continue</span>                                <span class="c">#after this, it should print messages in the Verilator terminal</span>
</code></pre></div></div>

<h3 id="ii-c-debug-with-eclipse">II. c) Debug with Eclipse</h3>

<p>Same procedure as <a href="#ii-b-debug-briey-soc-with-verilator--openocd--gdb">II. b) Debug Briey SoC with Verilator + OpenOCD + GDB</a> with three separated terminals. Just replace the GDB-terminal step with this Eclipse step: the Eclipse tool prepared in <a href="/tutorial/2022/09/30/Fresh-Ubuntu-setup#h-ii-f-eclipse">Fresh-Ubuntu-setup</a>.</p>

<p>Open the Eclipse tool, then import the example software folder:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. File --&gt; Import... --&gt; C/C++ --&gt; Existing Code as Makefile Project --&gt; Next &gt;
2. Browse to the software folder (briey_software/test/ for example)
3. Choose the "Cross GCC" (NOT the "RISC-V Cross GCC")
4. Choose the project name as you wanted, then click Finish
</code></pre></div></div>

<p>After imported, remember to check the file <code class="language-plaintext highlighter-rouge">resources/gcc.mk</code> for the <code class="language-plaintext highlighter-rouge">RISCV_PATH</code> variable for the correct path of your riscv toolchain.</p>

<p>To debug the program:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Right click on the software project --&gt; Debug As --&gt; Debug Configurations...
2. Choose the "GDB OpenOCD Debugging", then choose your debug configurations to debug
</code></pre></div></div>

<p><strong><em>note:</em></strong> if not yet config your Debug Configurations, then double-click on the “<strong>GDB OpenOCD Debugging</strong>” and follow these images to config it.</p>

<p><em>(on the image <strong>number 2</strong>, remember to check the <strong>correct path</strong> for the riscv toolchain)</em>
<img src="/assets/sources/VexRiscv/debug_configuration.png" alt="DebugConfig"></p>

<h3 id="ii-d-run-on-fpga">II. d) Run on FPGA</h3>

<p>Same procedure as <a href="#ii-b-debug-briey-soc-with-verilator--openocd--gdb">II. b) Debug Briey SoC with Verilator + OpenOCD + GDB</a> with three separated terminals. Just replace the Verilator-terminal step with a real hardware on an FPGA.</p>

<p>There are several FPGA demos available: <em>(click to the link to download the corresponding Quartus project folder)</em></p>

<ul>
  <li>Cyclone IV:
    <ul>
      <li><a href="/assets/sources/VexRiscv//DE2_115.rar">DE2-115</a></li>
      <li><a href="/assets/sources/VexRiscv//DE0_nano.rar">DE0-Nano</a></li>
    </ul>
  </li>
  <li>Cyclone V:
    <ul>
      <li><a href="/assets/sources/VexRiscv//DE1_SoC.rar">DE1-SoC</a></li>
      <li><a href="/assets/sources/VexRiscv//Arrow_SoCKit.rar">Arrow SoCKit</a></li>
    </ul>
  </li>
  <li>Stratix IV:
    <ul>
      <li><a href="/assets/sources/VexRiscv//DE4.rar">DE4</a></li>
      <li><a href="/assets/sources/VexRiscv//TR4.rar">TR4</a></li>
    </ul>
  </li>
</ul>

<p>All of the demos above are based on the Briey SoC with some modifications to fit in the corresponding FPGA.</p>

<p>Details about JTAG &amp; UART connections of each demo are in the file <strong>README.md</strong> in each of the corresponding folder. Example Eclipse projects are also included in the links.</p>

<h4 id="i-about-the-jtag-debugger">(i) About the JTAG debugger</h4>

<p>The demos use the Olimex debugger. Reference <a href="https://www.olimex.com/Products/ARM/JTAG/ARM-USB-TINY-H/">link</a>.</p>

<p>To install the driver for the debugger:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>vi /etc/udev/rules.d/olimex-arm-usb-tiny-h.rules
</code></pre></div></div>

<p>Then add this single line in the olimex-arm-usb-tiny-h.rules file:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SUBSYSTEM=="usb", ACTION=="add", ATTRS{idProduct}=="002a", ATTRS{idVendor}=="15ba", MODE="664", GROUP="plugdev"
</code></pre></div></div>

<h4 id="ii-run-a-demo-step-by-step">(ii) Run a demo step-by-step</h4>

<ol>
  <li>Download the corresponding Quartus project folder in the links above and program your FPGA board.</li>
  <li>Make sure that you have connected the JTAG &amp; UART to the FPGA board with correct connections as written in the <strong>README.md</strong> file.</li>
  <li>
    <p>Create OpenOCD terminal: the <code class="language-plaintext highlighter-rouge">vexriscv_openocd/</code> folder prepared in <a href="#i-c-vexriscvs-openocd">I.c) VexRiscv’s OpenOCD</a>.</p>

    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">cd </span>vexriscv_openocd/    <span class="c">#cd to your vexriscv_openocd folder</span>
 <span class="nv">$ </span>src/openocd <span class="nt">-f</span> tcl/interface/ftdi/olimex-arm-usb-tiny-h.cfg <span class="nt">-c</span> <span class="s2">"set BRIEY_CPU0_YAML &lt;cpu0.yaml PATH&gt;"</span> <span class="nt">-f</span> tcl/target/briey.cfg
   where &lt;cpu0.yaml PATH&gt; point to the file cpu0.yaml <span class="k">in </span>the VexRiscv folder
   For example:
   <span class="nv">$ </span>src/openocd <span class="nt">-f</span> tcl/interface/ftdi/olimex-arm-usb-tiny-h.cfg <span class="nt">-c</span> <span class="s2">"set BRIEY_CPU0_YAML /home/ubuntu/Projects/VexRiscv/cpu0.yaml"</span> <span class="nt">-f</span> tcl/target/briey.cfg
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create UART terminal: <em>(open a new one, don’t close the OpenOCD terminal)</em></p>

    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">sudo </span>minicom <span class="nt">-b</span> 115200 <span class="nt">-D</span> /dev/ttyUSBx
   where x is the number of connected USB-UART device
   For example:
   <span class="nv">$ </span><span class="nb">sudo </span>minicom <span class="nt">-b</span> 115200 <span class="nt">-D</span> /dev/ttyUSB0
</code></pre></div>    </div>
  </li>
  <li>Run or debug software <em>(by GDB or Eclipse)</em>
    <ul>
      <li>Using GDB: <em>(open a new one, don’t close the two terminals of OpenOCD &amp; UART)</em>
</li>
    </ul>

    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">PATH</span><span class="k">}</span>                            <span class="c">#check that if the riscv toolchain is on the PATH or not</span>
 <span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/opt/riscv/bin:<span class="nv">$PATH</span>        <span class="c">#if not, then export the riscv toolchain to the PATH</span>
    
 <span class="nv">$ </span><span class="nb">cd </span>software/                            <span class="c">#go to the software folder inside the Quartus project folder</span>
 <span class="nv">$ </span>riscv64-unknown-elf-gdb build/briey.elf
 <span class="nv">$ </span>target extended-remote localhost:3333
 <span class="nv">$ </span>monitor reset halt
 <span class="nv">$ </span>load
 <span class="nv">$ </span><span class="k">continue</span>                                <span class="c">#after this, it should print messages on the UART terminal</span>
</code></pre></div>    </div>
  </li>
</ol>

<ul>
  <li>Using Eclipse: the same as <a href="#ii-c-debug-with-eclipse">II. c) Debug with Eclipse</a>
</li>
</ul>

<h4 id="iii-note-to-update-software-with-changed-hardware">(iii) Note to update software with changed hardware</h4>

<p>The software folders in the links above were already synced up with their corresponding hardwares outside.</p>

<p>So, if you change the hardware properties, you will have to change the software as well. To be specific, mind the <code class="language-plaintext highlighter-rouge">libs/briey.h</code> file for addresses and <code class="language-plaintext highlighter-rouge">libs/briey.ld</code> for linker.</p>

<h4 id="iv-note-for-chip-demo">(iv) Note for chip demo</h4>

<p>For SOTB chip fabricated in Aug. 2019:</p>

<ul>
  <li>
    <p>Software demos: <strong>SOTB_Aug2019_*</strong> folders at <a href="https://github.com/thuchoang90/briey_software">github.com/thuchoang90/briey_software</a></p>
  </li>
  <li>
    <p>Hardware source: <strong>src/main/scala/vexriscv/demo/Briey_SOTB_Aug2019.scala</strong> file at <a href="https://github.com/thuchoang90/VexRiscv/tree/dev-chip">github.com/thuchoang90/VexRiscv/tree/dev-chip</a></p>
  </li>
</ul>

<p>For ROHM chip fabricated in Jan. 2020:</p>

<ul>
  <li>
    <p>Software demos: <strong>ROHM_Jan2020_*</strong> folders at <a href="https://github.com/thuchoang90/briey_software">github.com/thuchoang90/briey_software</a></p>
  </li>
  <li>
    <p>Hardware sources: <strong>src/main/scala/vexriscv/demo/Briey_ROHM_Jan2020.scala</strong> file at <a href="https://github.com/thuchoang90/VexRiscv/tree/dev-chip">github.com/thuchoang90/VexRiscv/tree/dev-chip</a></p>
  </li>
</ul>


    </div>

</article>
<div class="post-nav">
<a class="previous" href="/jekyll-theme-yat/project/2020/07/11/keystone-ethernet-driver.html" title="Keystone: turn on ethernet driver">Keystone: turn on ethernet driver</a><a class="next" href="/jekyll-theme-yat/project/2020/07/24/Keystone-makefile-32.html" title="Keystone 32-bit build using Makefile">Keystone 32-bit build using Makefile</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/jekyll-theme-yat/project/2020/04/27/freedom-chisel.html" title="Keystone 32-bit build using Makefile">SiFive Freedom: chisel code structure</a></li>
<li><a class="post-link" href="/jekyll-theme-yat/tutorial/2022/09/30/Fresh-Ubuntu-setup.html" title="Keystone 32-bit build using Makefile">Fresh Ubuntu (20.04 &amp; 22.04) setup for working with RISC-V</a></li>
<li><a class="post-link" href="/jekyll-theme-yat/example/2017/12/15/table-example.html" title="Keystone 32-bit build using Makefile">Table example</a></li>
<li><a class="post-link" href="/jekyll-theme-yat/markdown/2015/02/28/test-markdown.html" title="Keystone 32-bit build using Makefile">Test markdown</a></li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">Content</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/jekyll-theme-yat/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>Enjoy building world!</div>
    </div>
  </div>
</footer>
</body>
</html>
